// Generated by CoffeeScript 1.12.7
(function() {
  var SelectizeAjax;

  window.clearSelectizeModal = function(modal) {
    modal.find('.modal-header').empty();
    modal.find('.modal-body').empty();
    return modal.data('bs.modal', null);
  };

  window.SelectizeAjax = SelectizeAjax = (function() {
    var _self, default_options;

    default_options = {
      resource_id: '',
      resource_name: '',
      collection: '{}',
      collection_path: null,
      search_param: 'q',
      add_modal: null,
      edit_modal: null,
      edit_resource_template: null
    };

    _self = function() {
      return this;
    };

    function SelectizeAjax(options) {
      if (options == null) {
        options = {};
      }
      _self.options = Object.assign(default_options, options);
      this.initialize();
    }

    SelectizeAjax.prototype.initialize = function() {
      if (_self.options.resource_id == null) {
        return;
      }
      this.selectize_control();
      return this.control_buttons();
    };

    SelectizeAjax.prototype.selectize_control = function() {
      return $("#" + _self.options.resource_id).selectize({
        persist: false,
        maxItems: 1,
        valueField: 'value',
        labelField: 'label',
        sortField: 'label',
        searchField: 'label',
        options: _self.options.collection,
        render: {
          item: function(item, escape) {
            return ['<div>', (item.label ? '<span>' + escape(item.label) + '</span>' : ''), '</div>'].join(' ');
          }
        },
        load: function(query, callback) {
          var obj, self;
          if (!query.length || (_self.options.collection_path == null)) {
            return callback();
          }
          self = this;
          return $.ajax({
            url: _self.options.collection_path,
            type: 'GET',
            dataType: 'json',
            data: (
              obj = {},
              obj["" + _self.options.search_param] = query,
              obj
            ),
            error: function() {
              callback();
            },
            success: function(res) {
              self.clearOptions();
              return callback(res);
            }
          });
        }
      });
    };

    SelectizeAjax.prototype.control_buttons = function() {
      if (_self.options.add_modal != null) {
        this.ajax_add_complete_script();
        this.clear_add_form_script();
      }
      if (_self.options.edit_modal != null) {
        this.ajax_edit_complete_script();
        return this.edit_button_script();
      }
    };

    SelectizeAjax.prototype.ajax_add_complete_script = function() {
      return $(_self.options.add_modal).on('ajax:complete', function(evt, data, status, errors) {
        var $selector, $this, provider, selectizer;
        if (data == null) {
          return console.error('Somthing went wrong, form submit return empty response.');
        }
        if (data.status === 200 || data.status === 201) {
          if (data.responseJSON === null) {
            $(_self.options.add_modal).find('.modal-content').html(data.responseText);
            return $(_self.options.add_modal).trigger('error');
          } else {
            $this = $(this);
            provider = JSON.parse(data.responseText);
            selectizer = $("#" + _self.options.resource_id)[0].selectize;
            selectizer.addOption(provider);
            selectizer.addItem(provider.value);
            $(_self.options.add_modal).modal('hide');
            $selector = $("form[data-target=\"" + _self.options.add_modal + "\"");
            if ($selector.length > 0) {
              return $selector[0].reset();
            }
          }
        }
      });
    };

    SelectizeAjax.prototype.clear_add_form_script = function() {
      return $(_self.options.add_modal).on('hidden.bs.modal, show.bs.modal', function() {
        var $selector;
        $selector = $("form[data-target=\"" + _self.options.add_modal + "\"");
        if ($selector.length > 0) {
          $selector[0].reset();
        }
        $('.error').each(function() {
          return $(this).remove();
        });
        return $('.field_with_errors').each(function() {
          return $(this).removeClass('field_with_errors');
        });
      });
    };

    SelectizeAjax.prototype.ajax_edit_complete_script = function() {
      $(document).on('hidden.bs.modal', _self.options.edit_modal, function() {
        return clearSelectizeModal($(this));
      });
      return $(document).on('ajax:complete', _self.options.edit_modal, function(e, data) {
        if (data.responseJSON === null) {
          $(_self.options.edit_modal).find('.modal-content').html(data.responseText);
          return $(_self.options.edit_modal).trigger('error');
        } else {
          data = data.responseJSON;
          $(_self.options.edit_modal).modal('hide');
          if (data.value !== null && data.label !== null) {
            $('div[data-value=\'' + data.value + '\']').find('span').text(data.label);
            return $('div.selected[data-value=\'' + data.value + '\']').text(data.label);
          }
        }
      });
    };

    SelectizeAjax.prototype.edit_button_script = function() {
      var $edit_link;
      $edit_link = $(".edit-" + _self.options.resource_name);
      if (!$("#" + _self.options.resource_id).val()) {
        $edit_link.hide();
        $("#" + _self.options.resource_id).closest('.selectize-ajax-wrapper').addClass('selectize-ajax-wrapper--empty');
      } else {
        $edit_link.attr('href', _self.options.edit_resource_template.replace('{{id}}', $("#" + _self.options.resource_id).val()));
      }
      return $(document).on('change', "#" + _self.options.resource_id, function() {
        if (!$(this).val()) {
          $("#" + _self.options.resource_id).closest('.selectize-ajax-wrapper').addClass('selectize-ajax-wrapper--empty');
          return $edit_link.hide();
        }
        $edit_link.show();
        $edit_link.attr('href', _self.options.edit_resource_template.replace('{{id}}', $("#" + _self.options.resource_id).val()));
        return $("#" + _self.options.resource_id).closest('.selectize-ajax-wrapper').removeClass('selectize-ajax-wrapper--empty');
      });
    };

    return SelectizeAjax;

  })();

}).call(this);
